


DECLARE @FromDate date = NULL;  -- e.g. '2025-10-20'
DECLARE @ToDate   date = NULL;  -- e.g. '2025-10-27'
DECLARE @OnlyRegularSession bit = 1; -- 1 = regular hours only, 0 = all bars

;WITH scope_bars AS (
    SELECT b.StockId, b.TimeframeId, b.TsUtc, b.Volume, b.TradeCount, b.[Close], b.Vwap
    FROM dbo.BAR b
    WHERE b.TimeframeId = 1
      AND (@FromDate IS NULL OR b.TradingDate >= @FromDate)
      AND (@ToDate   IS NULL OR b.TradingDate <= @ToDate)
      AND (
            @OnlyRegularSession = 0
         OR (
                DATENAME(WEEKDAY, CAST((b.TsUtc AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time') AS date))
                    NOT IN ('Saturday','Sunday')
             AND CAST((b.TsUtc AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time') AS time) >= '09:30'
             AND CAST((b.TsUtc AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time') AS time) <  '16:00'
         )
      )
),
m AS (
    SELECT
        StockId, TimeframeId, TsUtc, Volume, TradeCount, [Close], Vwap,
        CASE WHEN TradeCount > 0 THEN 1.0 * Volume / TradeCount END AS ATS,
        CASE WHEN Vwap > 0 THEN ([Close] - Vwap) / Vwap END           AS VDev
    FROM scope_bars
),
w AS (
    SELECT
        StockId, TimeframeId, TsUtc, Volume, ATS, VDev,
        -- ATS_MA_15
        AVG(ATS) OVER (PARTITION BY StockId ORDER BY TsUtc
                       ROWS BETWEEN 14 PRECEDING AND CURRENT ROW) AS ATS_MA_15,

        -- 60-bar rolling means/stds for ATS, Volume, VDev
        AVG(ATS)    OVER (PARTITION BY StockId ORDER BY TsUtc
                          ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS ATS_MEAN_60,
        STDEV(ATS)  OVER (PARTITION BY StockId ORDER BY TsUtc
                          ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS ATS_STD_60,

        AVG(Volume) OVER (PARTITION BY StockId ORDER BY TsUtc
                          ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS VOL_MEAN_60,
        STDEV(Volume) OVER (PARTITION BY StockId ORDER BY TsUtc
                            ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS VOL_STD_60,

        AVG(VDev) OVER (PARTITION BY StockId ORDER BY TsUtc
                        ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS DEV_MEAN_60,
        STDEV(VDev) OVER (PARTITION BY StockId ORDER BY TsUtc
                          ROWS BETWEEN 59 PRECEDING AND CURRENT ROW) AS DEV_STD_60
    FROM m
),
z AS (
    SELECT
        StockId, TimeframeId, TsUtc, Volume, ATS, VDev, ATS_MA_15,
        -- ATS_MA_60 is just the 60-bar mean
        ATS_MEAN_60                                          AS ATS_MA_60,
        -- Z-scores
        CASE WHEN ATS_STD_60 > 0 THEN (ATS - ATS_MEAN_60) / ATS_STD_60 END AS ATS_Z_60,
        -- 15-bar Z for ATS
        CASE
            WHEN COUNT(*) OVER (PARTITION BY StockId ORDER BY TsUtc
                                 ROWS BETWEEN 14 PRECEDING AND CURRENT ROW) >= 2
            THEN
                (ATS
                  - AVG(ATS)   OVER (PARTITION BY StockId ORDER BY TsUtc ROWS BETWEEN 14 PRECEDING AND CURRENT ROW))
                /
                NULLIF(STDEV(ATS) OVER (PARTITION BY StockId ORDER BY TsUtc ROWS BETWEEN 14 PRECEDING AND CURRENT ROW),0)
        END AS ATS_Z_15,

        CASE WHEN VOL_STD_60 > 0 THEN (Volume - VOL_MEAN_60) / VOL_STD_60 END AS VOL_Z_60,
        CASE WHEN DEV_STD_60 > 0 THEN (VDev   - DEV_MEAN_60) / DEV_STD_60 END AS DEV_Z_60
    FROM w
),
x AS (
    SELECT
        StockId, TimeframeId, TsUtc,
        ATS,
        ATS_MA_15,
        ATS_MA_60,
        ATS_Z_15,
        ATS_Z_60,
        -- IFI_60 (signed): sign(VDev)*(0.5*|DEV_Z_60| + 0.3*VOL_Z_60 + 0.2*ATS_Z_60)
        CASE
          WHEN DEV_Z_60 IS NOT NULL AND VOL_Z_60 IS NOT NULL AND ATS_Z_60 IS NOT NULL AND VDev IS NOT NULL
          THEN SIGN(VDev) * (0.5*ABS(DEV_Z_60) + 0.3*VOL_Z_60 + 0.2*ATS_Z_60)
        END AS IFI_60
    FROM z
)
SELECT
    StockId, TimeframeId, TsUtc,
    MetricCode, Period,
    CAST(Val AS decimal(19,8)) AS Value,
    ParamsJson = NULL
INTO #ind
FROM x
CROSS APPLY (VALUES
    ('ATS',        CONVERT(smallint, 0),  CAST(ATS        AS float)),
    ('ATS_MA_15',  CONVERT(smallint,15),  CAST(ATS_MA_15  AS float)),
    ('ATS_MA_60',  CONVERT(smallint,60),  CAST(ATS_MA_60  AS float)),
    ('ATS_Z_15',   CONVERT(smallint,15),  CAST(ATS_Z_15   AS float)),
    ('ATS_Z_60',   CONVERT(smallint,60),  CAST(ATS_Z_60   AS float)),
    ('IFI_60',     CONVERT(smallint,60),  CAST(IFI_60     AS float))
) v(MetricCode, Period, Val)
WHERE v.Val IS NOT NULL;

-- Upsert
MERGE dbo.INDICATOR_VALUE AS t
USING #ind AS s
   ON t.StockId=s.StockId
  AND t.TimeframeId=s.TimeframeId
  AND t.TsUtc=s.TsUtc
  AND t.MetricCode=s.MetricCode
  AND t.Period=s.Period
WHEN MATCHED THEN
  UPDATE SET t.Value=s.Value, t.ParamsJson=s.ParamsJson, t.UpdatedUtc=SYSUTCDATETIME()
WHEN NOT MATCHED THEN
  INSERT (StockId,TimeframeId,TsUtc,MetricCode,Period,ParamsJson,Value,UpdatedUtc)
  VALUES (s.StockId,s.TimeframeId,s.TsUtc,s.MetricCode,s.Period,s.ParamsJson,s.Value,SYSUTCDATETIME());

DROP TABLE #ind;



